<!DOCTYPE html>
<html>

<head>
  <title>化学式配平器</title>
  <meta http-equiv="content-type" content="txt/html; charset=utf-8" />
  <meta Name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>

<body>
  <div id="主体">
    <div id="标题">化学式配平器 v1.0</div>
    <div id="主题">
      <span>请输入未配平的化学式: 如 H2+O2=H2O</span>
      <br>
      <input></input>
      <button onclick="配平()">配平</button>
    </div>
    <hr>
    <div id="输出"></div>
  </div>
</body>

</html>


<script>
  var c = "";
  var n = 0, a = 0, l = 0, z = 0;
  var N = 0, K = 0;
  var Name = new Array();
  var t = new Array();
  var m = new Array();
  var ans = new Array();
  var Ans = new Array();
  for (let i = 0; i <= 50; i++) {
    Name[i] = "";
  }
  for (let i = 0; i <= 50; i++) {
    t[i] = "";
  }
  for (let i = 0; i <= 50; i++) {
    m[i] = new Array();
    for (let j = 0; j <= 50; j++) {
      m[i][j] = new frac();
    }
  }
  for (let i = 0; i <= 100; i++) {
    ans[i] = new frac();
  }
  for (let i = 0; i <= 100; i++) {
    Ans[i] = 0;
  }
  function gcd(a, b) {
    return b ? gcd(b, a % b) : a;
  }
  function lcm(a, b) {
    return a / gcd(a, b) * b;
  }
  function frac(a, b) {
    this.a = a;
    this.b = b;
    let x = gcd(this.a, this.b);
    this.a /= x, this.b /= x;
  }
  function jia(y, x) {
    return new frac(x.b * y.a + y.a * y.b, x.b * y.b);
  }
  function jian(y, x) {
    return new frac(y.a * x.b - y.b * x.a, y.b * x.b);
  }
  function cheng(y, x) {
    return new frac(y.a * x.a, y.b * x.b);
  }
  function chu(y, x) {
    return new frac(y.a * x.b, y.b * x.a);
  }
  function xiaoyu(y, x) {
    return (y.a * x.b) < (y.b * x.a);
  }
  function dengyu(y, x) {
    return (y.a * x.b) == (y.b * x.a);
  }
  function Abs(x) {
    return x.a > 0 ? (x.b > 0 ?new frac(x.a, x.b) :new frac(x.a, -x.b)) : (x.b > 0 ?new frac(-x.a, x.b) :new frac(-x.a, -x.b));
  }
  function qsum(x, k) {
    var sum = 0;
    for (let i = 0; i < Name[x].length; i++) {
      var f = false;
      for (let j = 0; j < t[k].length; j++) {
        if (t[k][j] != Name[x][i + j]) {
          f = true;
          break;
        }
      }
      if (f) continue;
      if (t[k].length == 1 && 'a' <= Name[x][i + 1] && Name[x][i + 1] <= 'z') continue;
      var s = 1, pos = i + t[k].length;
      if (Name[x][pos] >= '0' && Name[x][pos] <= '9') {
        s = 0;
        while (Name[x][pos] >= '0' && Name[x][pos] <= '9') s = s * 10 + Number(Name[x][pos]), pos++;
      }
      for (let j = pos; j < Name[x].length; j++) {
        if (Name[x][j] == '(') break;
        if (Name[x][j] == ')') {
          var s2 = 1, pos2 = j + 1;
          if (Name[x][pos2] >= '0' && Name[x][pos2] <= '9') {
            s2 = 0;
            while (Name[x][pos2] >= '0' && Name[x][pos2] <= '9') s2 = s2 * 10 + Number(Name[x][pos2]), pos2++;
          }
          s *= s2;
          break;
        }
      }
      sum += s;
    }
    return sum;
  }
  function solve() {
    ans[n] = new frac(1, 1);
    for (let i = 1; i <= a; i++) m[i][n].a = -m[i][n].a;
    N = n - 1, K = a;
    for (let k = 1; k <= N; k++) {
      var maxm = new frac(-1, 1);
      var maxi;
      for (let i = k; i <= K; i++) if (xiaoyu(maxm, Abs(m[i][k]))) maxm = Abs(m[i][k]), maxi = i;
      if (xiaoyu(maxm, new frac(0, 1))) return false;
      if (maxi != k) {
        var tra;
        for (let j = 1; j <= N + 1; j++) {
          tra = m[k][j]; 
          m[k][j] = m[maxi][j]; 
          m[maxi][j] = tra;
        }
      } 
      var tmp = m[k][k];
      for (let j = 1; j <= N + 1; j++) m[k][j] = chu(m[k][j], tmp);
      for (let i = k - 1 ? 1 : 2; i <= K; i++) {
        if (i == k) continue;
        tmp = m[i][k];
        for (let j = 1; j <= N + 1; j++)m[i][j] = jian(m[i][j], cheng(tmp, m[k][j]));
      }
    }
    return true;
  }

  window.$ = function (selector) {
    return document.querySelector(selector);
  }

  function 配平() {
    c = $('input').value
    l = c.length;
    var Leg = 1;
    var has = 0;
    for (let i = 0; i < l; i++) if ('A' <= c[i] && c[i] <= 'Z') has = 1;
    var last = 0;
    for (let p = 0; p < l; p++) {
      if (c[p] == '+' || c[p] == '=') {
        n++;
        if (c[p] == '=') z = n;
        for (let i = 0; i < p - last; i++) Name[n] += c[i + last];
        last = p + 1;
      }
      if (p == l - 1) {
        n++;
        for (let i = 0; i <= p - last; i++) Name[n] += c[i + last];
      }
    }
    for (let x = 1; x <= n; x++) {
      for (let j = 0; j < Name[x].length; j++) {
        if ('Z' < Name[x][j] || Name[x][j] < 'A') continue;
        var test = "";
        test += Name[x][j];
        if ('a' <= Name[x][j + 1] && Name[x][j + 1] <= 'z') {
          test += Name[x][j + 1];
        }
        var f = true;
        for (let i = 1; i <= a; i++) {
          if (t[i] == test) {
            f = false;
            break;
          }
        }
        if (f) {
          a++;
          t[a] = test;
        }
      }
    }
    for (let j = 1; j <= a; j++) {
      for (let i = 1; i <= z; i++) m[j][i] =new frac(qsum(i, j), 1);
      for (let i = z + 1; i <= n; i++) m[j][i] =new frac(-qsum(i, j), 1);
    }
    for (let j = 1; j <= a; j++) {
      var f1 = 0, f2 = 0;
      for (let i = 1; i <= z; i++) if (qsum(i, j)) f1 = 1;
      for (let i = z + 1; i <= n; i++) if (qsum(i, j)) f2 = 1;
      if (f1 ^ f2) Leg = 0;
    }
    var Output = "";
    if (has && Leg && solve()) {
      for (let i = 1; i <= n - 1; i++) ans[i] = m[i][N + 1];
      var Lcm = lcm(ans[1].b, ans[2].b);
      for (let i = 3; i <= n; i++) Lcm = lcm(Lcm, ans[i].b);
      for (let i = 1; i <= n; i++) Ans[i] = ans[i].a * Lcm / ans[i].b;
      for (let i = 1; i <= n; i++) {
        if (Ans[i] > 1) Output += Ans[i];
        Output += Name[i];
        if (i == n) break;
        else if (i == z) Output += "=";
        else Output += "+";
      }
    } else Output = "请输入一个合法的方程式~\xa0(｡･ω･｡)ﾉ♥";
    Output += "\xa0\xa0\xa0\xa0\xa0\xa0\xa0\xa0再来一次，请刷新页面~";
    $('#输出').innerHTML = Output;
  }

</script>


<style>
  @media screen and (max-width: 1024px) {
    html {
      font-size: 2vw;
      color: #333333;
    }

    body {
      margin: 0;
    }

    #主体 {
      border: 2px solid #333333;
      margin: 6px;
      padding: 6px;
      background: #f8f8f8;
    }

    #标题 {
      font-size: 3rem;
      line-height: 3rem;
      text-align: center;
    }

    #主题 {
      text-align: center;
      margin-top: 6px;
      font-size: 0px;
    }

    #主题 span {
      font-size: 2rem;
      vertical-align: baseline;
      margin-left: 6px;
    }

    #主题 input {
      border: none;
      border-bottom: #666666 2px solid;
      padding: 1px 0 0 0;
      margin: 0px 6px 0 6px;
      vertical-align: baseline;
      font-size: 2rem;
      background: #f8f8f8;
      color: #333333;
      text-align: center;
      min-width: 20%;
    }

    #主题 button {
      border: 0;
      padding: 3px 7px 3px 7px;
      margin: 0;
      vertical-align: top;
      font-size: 1.4rem;
      background: #454545;
      color: #efefef;
    }

    #输出 div {
      margin-top: 6px;
      font-size: 2rem;
      text-align: center;
    }
  }

  @media screen and (min-width: 1024px) {
    html {
      font-size: 1.3vw;
      color: #333333;
    }

    body {
      margin: 0;
    }

    #主体 {
      border: 2px solid #333333;
      margin: 20px;
      padding: 20px;
      background: #f8f8f8;
    }

    #标题 {
      font-size: 1.9rem;
      line-height: 1.9rem;
      text-align: center;
    }

    #主题 {
      text-align: center;
      margin-top: 20px;
      font-size: 0px;
    }

    #主题 span {
      font-size: 1rem;
      vertical-align: baseline;
      margin-left: 20px;
    }

    #主题 input {
      border: none;
      border-bottom: #666666 2px solid;
      padding: 1px 0 0 0;
      margin: 0px 20px 0 20px;
      vertical-align: baseline;
      font-size: 1rem;
      background: #f8f8f8;
      color: #333333;
      text-align: center;
      min-width: 20%;
    }

    #主题 button {
      border: 0;
      padding: 5px 15px 5px 15px;
      margin: 0;
      vertical-align: top;
      font-size: 0.75rem;
      background: #454545;
      color: #efefef;
    }
    #输出 div {
      text-align: center;
      margin-top: 20px;
    }
  }
</style>
